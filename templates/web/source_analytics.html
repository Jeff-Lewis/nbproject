<!DOCTYPE html>
<html class="nb_fullscreen">
  <head>
<!--
   Author: cf AUTHORS.txt 
   License:  Copyright (c) 2010-2012 Massachusetts Institute of Technology.
   MIT License (cf. MIT-LICENSE.txt or http://www.opensource.org/licenses/mit-license.php)
  -->
    <title>NB Analytics</title>
    <link type="text/css" href="/content/compiled/docanalytics.css" rel="stylesheet" />
    <script type="text/javascript" src="/content/compiled/docanalytics_NB.js"></script>
    <script type="text/template" id="page-template">
      <a class="page-link" id="link-<%=page_num%>" href="/f/{{ source.id }}?p=<%=page_num%>" target="_blank">
        <div id="page-preview-<%= page_num %>">
          <img class="page-img" id="page-img-<%= page_num %>" src="<%= img_url %>">
        </div>
      </a>
        <span class="page-num page-label"><%= page_num %></span>
        <div class="page-stats">
          <span class="threads color-stat"><span class="val"><%= num_threads %></span> threads</span>
          <br/><span class="annotations color-stat"><span class="val"><%= num_annotations %></span> comments</span>
          <br/><span class="questions color-stat"><span class="val"><%= num_questions %></span> replies req.</span>
          <br/><span class="participants color-stat"><span class="val"><%= num_participants %></span> participants</span>
        </div>
        <div class="clearfix"></div>
    </script>
    <script type="text/template" id="highlight-template">
      <div class="highlight" style="top:<%= y %>px; left:<%= x %>px; width: <%= w %>px; height: <%= h %>px;">
      </div>
    </script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script>
      // For logging
      window.onload = function() {
        var key = {{ source.id }}+"|"+(new Date()).getTime();
        var payload = {};
        payload[key]=(new Date()).getTime();
        NB.pers.call("log_history", {"analytics": payload}, function(callback) {});
      };

      var recordAction = function(control, value) {
        var key = {{ source.id }}+"|"+control+"|"+value;
        var payload = {};
        payload[key]=(new Date()).getTime();
        NB.pers.call("log_history", {"analyticsClick": payload}, function(callback) {});
      }
    </script>
    <script type="text/javascript">
      var chart_stats = {{ chart_stats|safe }};
      google.load("visualization", "1", {packages:["corechart"]});
      google.setOnLoadCallback(drawChart);
      function drawChart() {
        var data = new google.visualization.DataTable();
        data.addColumn('string','Page');
        data.addColumn('number','Threads');
        data.addColumn('number','Comments');
        data.addColumn('number','Replies requested');
        data.addColumn('number', 'Participants');
        data.addColumn('number', 'Total time');
        data.addColumn('number', 'Avg time');
        data.addRows(chart_stats);
        
        var options = {
          title: 'Page Stats',
          hAxis: {title: 'Page'},
        };

        var view = new google.visualization.DataView(data);
        var chart = new google.visualization.ColumnChart(document.getElementById('chart_div'));

        var metric_mapping = {
          "Threads": {
            "col":1,
            "color": "#3366CC",
            "on": true,
          },
          "Annotations": {
            "col":2,
            "color": "#FF7100",
            "on": true,
          },
          "Replies Requested": {
            "col":3,
            "color": "#109618",
            "on": true,
          },
          "Participants": {
            "col":4,
            "color": "#990099",
            "on": true,
          },
          "Total Time": {
            "col":5,
            "color": "#21B7CC",
            "on": false,
          },
          "Average Time": {
            "col":6,
            "color": "#CC89C7",
            "on": false,
          }
        };

        var drawChart = function() {
          var metrics_on = [0];
          var colors_on = [];
          for (m in metric_mapping) {
            var obj = metric_mapping[m];
            if (obj["on"]) {
              metrics_on.push(obj["col"]);
              colors_on.push(obj["color"]);
            }
          }
          options.colors = colors_on;
          view.setColumns(metrics_on);
          chart.draw(view, options);
        }

        drawChart();

        (function($){

          $(".chart-toggle").on("click", function() {
            var metric = $(this).val();
            var status = metric_mapping[metric]["on"];
            metric_mapping[metric]["on"] = status ? false : true;
            drawChart();
            recordAction('chart-toggle', metric); 
          });

          var pgLabelClass = 'page-label';
          var pgPreviewClass = 'pg-preview';

          $('text').each(function(i, el) {
            var obj = $(el);
            var n = obj.text();
            if ($.isNumeric(n)) {
              obj.attr('class', pgLabelClass);
            }
          });

          // TODO: move this out of drawChart() function
          $('.'+pgLabelClass).on({
            mouseenter: function() {
              var num = $(this).text();
              var contents = $('#page-preview-'+num).html();
              $('.'+pgPreviewClass).html(contents);

              // get the larger image for the preview
              var img_server = "http://nb.mit.edu";
              var ckey = NB.conf.userinfo.ckey;
              var img_url = img_server + "/pdf/cache2/72/100/"+{{ source.id }}+"?ckey="+ckey+";page=" + num;
              $('.'+pgPreviewClass).find('.page-img').attr("src", img_url);

              $('.'+pgPreviewClass).children(".highlight").each(function(i, el) {
                var s = 5;  // scale factor (for res 20 images)
                $(el).height($(el).height()*s);
                $(el).width($(el).width()*s);
                $(el).css("top", $(el).css("top").replace(/[^-\d\.]/g, '')*s);
                $(el).css("left", $(el).css("left").replace(/[^-\d\.]/g, '')*s);
              });
              $('.'+pgPreviewClass).show();
              recordAction('pagenum-hover', num);
            },
            mouseleave: function() {
              $('.'+pgPreviewClass).hide();
            }
          });

          // to avoid flicker when preview overlaps page number 
          $('.'+pgPreviewClass).on({
            mouseenter: function() {
              $('.'+pgPreviewClass).show();
            },
            mouseleave: function() {
              $('.'+pgPreviewClass).hide();
            }
          });

        })(jQuery); 
      }

    </script>
    <script type="text/javascript" src="/content/modules/dev/ui.docAnalyticsBackboneViews.js"></script>

    <script>
      (function($){
        $(document).ready(function() {
            var pages = {{ pages|safe }};
            var highlights = {{ highlights|safe }};
            var doc = new Document();
            
            var orientation;
            if ({{ source.h }} > {{ source.w }}) {
              orientation = "portrait";
            } else {
              orientation = "landscape";
            };

            var page;

            for (p in pages) {
              page = new Page(pages[p]);  

              // TODO: better way to get the source ID/ckey?
              var img_server = "http://nb.mit.edu";
              // var img_server = "";
              var ckey = NB.conf.userinfo.ckey;
              var img_url = img_server + "/pdf/cache2/72/20/"+{{ source.id }}+"?ckey="+ckey+";page=" + p;
              page.set('img_url', img_url); // TODO: put img url in PageView?

              doc.add(page);
            }

            var documentView = new DocumentView({
              collection: doc,
              el: $("#pages-container"),
            });
            documentView.render();

            for (h in highlights) {
              var highlight = new Highlight(highlights[h]);
              highlight.set("page_orientation", orientation);
              var highlightView = new HighlightView({ model: highlight});
            }

            $(".color-stat").each(function(i, el) {
              var val = $(el).children(".val").text();
              var o = 1.0;
              var c = rgb2hex($(el).css("color"));
              var newC;
              // gradients set by arbitrary intervals // TODO make them different for each metric?
              if (val > 0) {
                $(el).css("opacity", o);
                if (val < 10) {
                  newC = LightenDarkenColor(c, 10);
                } 
                else if (val < 20) {
                  // newC = LightenDarkenColor(c, -20);
                } else if (val < 30) {
                  newC = LightenDarkenColor(c, -10);
                } else {
                  newC = LightenDarkenColor(c, -20);
                }
                $(el).css("color", newC);
              }
            });

            /////////////// handlers

            $("#sort-by").on('change', function() {
              var attr = $(this).val();
              doc.sortByField(attr);
              recordAction('page-sort-by', attr);
            })

            $("#show-filter").on('change', function() {
              var property = $(this).val();
              var num = 0; // TODO: make this flexible (another HTML property?)
              documentView.filterByPropertyAndNum(property, num);
              recordAction('page-filter', property);
            })

            $(".page-link").on('click', function() {
              var num = $(this).attr('id').split("link-")[1];
              recordAction('pagethumb-click', num);
            })
        });
      })(jQuery);
    </script>


  </head>
  <body>
    <div class='nb-viewport'><div class='nb-widget-header' style='height:24px;' /></div>
    <div class="main-wrapper">
      <h1><a href="/f/{{ source.id }}" class="header-link">{{ source.title }}</a></h1>
      <div class="feedback-prompt">
        <!-- Is this helpful? -->
        <a class="feedback-btn" target="_blank" href="https://docs.google.com/forms/d/1iTxDtr-tohbyRZAgcIUjM8ACBmyfssO98xVFBzWjc4Q/viewform">Send Feedback</a>
      </div>    
      <div class="panel chart">
        <div class="control-bar">
          <label>Display stats for:</label> 
          <input type="checkbox" class="chart-toggle" checked value="Threads"/>Threads
          <input type="checkbox" class="chart-toggle" checked value="Annotations"/>Comments
          <input type="checkbox" class="chart-toggle" checked value="Replies Requested"/>Replies Requested
          <input type="checkbox" class="chart-toggle" checked value="Participants"/>Participants
          <input type="checkbox" class="chart-toggle" value="Total Time"/>Total Time (min)
          <input type="checkbox" class="chart-toggle" value="Average Time"/>Average Time (min)
        </div>
        <div class="panel-content">
          <div id="chart_div" style="width:90%;"></div>
        </div>
      </div>

      <div class="panel heatmap">
        <div class="control-bar">
          <div class="controls">
            <label>Show: </label>
            <select id="show-filter">
              <option value="all">All pages</option>
              <option value="annotations">Pages with comments</option>
              <option value="questions">Pages with replies requested</option>
            </select>
          
            <label>Sort by: </label>
            <select id="sort-by">
              <option value="page_num">Page number</option>
              <option value="num_threads">Number of threads</option>
              <option value="num_annotations">Number of comments</option>
              <option value="num_questions">Number of replies requested</option>
              <option value="num_participants">Number of participants</option>
            </select>
          </div>
        <span class="tip">
          Hover over page numbers for enlarged views. Click page images to view annotations in NB.
        </span>
      </div>
      <div class="panel-content">
        <div id="pages-container"></div>
        <div class="clearfix"></div>
      </div>
    </div>
    </div>

    <div class="pg-preview"><img class="img-enlarged" /></div>


  </body>
</html>
